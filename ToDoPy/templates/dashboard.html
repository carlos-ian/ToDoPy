<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDoPy - Dashboard</title>
    <link rel="stylesheet" href="../Static/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <input type="checkbox" id="modal-control" class="modal-state">

    <header class="main-header">
        <div class="header-top">
            <div class="logo">
                <i class="fas fa-clipboard-check"></i>
                <span>ToDoPy - Gerenciador de Tarefas</span>
            </div>
        </div>
    </header>

    <main class="content-wrapper">
        <section class="controls">
            <div class="filter-group">
                <select id="filter-category" class="styled-select">
                    <option value="">Todas as Categorias</option>
                    <option value="Estudo">Estudo</option>
                    <option value="Trabalho">Trabalho</option>
                    <option value="Pessoal">Pessoal</option>
                </select>
                <select id="filter-importance" class="styled-select">
                    <option value="">Todas as Prioridades</option>
                    <option value="Baixa">Baixa</option>
                    <option value="Razoável">Razoável</option>
                    <option value="Importante">Importante</option>
                </select>
                <div class="date-filter">
                    <input type="date" id="filter-date" class="styled-select">
                    <button id="clear-date" class="btn-clear" title="Limpar data">&times;</button>
                </div>
            </div>
            <label for="modal-control" class="btn-add"><i class="fas fa-plus"></i> Nova Tarefa</label>
        </section>

        <section class="kanban-board">
            <div class="kanban-column">
                <h3 class="column-title">To Do</h3>
                <div id="tasks-todo" class="task-list"></div>
            </div>
            <div class="kanban-column">
                <h3 class="column-title">In Progress</h3>
                <div id="tasks-progress" class="task-list"></div>
            </div>
            <div class="kanban-column">
                <h3 class="column-title">Done</h3>
                <div id="tasks-done" class="task-list"></div>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-info">
                <span>&copy; 2026 ToDoPy - Organize sua rotina com ToDoPy.</span>
            </div>
            <div class="footer-social">
                <i class="fab fa-github"></i>
                <i class="fab fa-linkedin"></i>
                <i class="fas fa-envelope"></i>
            </div>
        </div>
    </footer>

    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Tarefa</h2>
                <label for="modal-control" class="close-modal">&times;</label>
            </div>
            <form class="task-form">
                <div class="input-group">
                    <label>Título da Tarefa</label>
                    <input type="text" id="task-title" placeholder="Ex: Estudar Inglês" required>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Data</label>
                        <input type="date" id="task-date" required>
                    </div>
                    <div class="input-group">
                        <label>Classificação (Status)</label>
                        <select id="task-status" required>
                            <option value="To Do">To Do</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Categoria</label>
                        <select id="task-category" required>
                            <option value="Estudo">Estudo</option>
                            <option value="Trabalho">Trabalho</option>
                            <option value="Pessoal">Pessoal</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Importância</label>
                        <select id="task-importance" required>
                            <option value="Baixa">Baixa</option>
                            <option value="Razoável">Razoável</option>
                            <option value="Importante">Importante</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <label for="modal-control" class="btn-cancel">Cancelar</label>
                    <button type="submit" class="btn-save">Criar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8000";
        const token = localStorage.getItem('token');
        let allTasks = [];

        if (!token) window.location.href = "login.html";

        async function loadTasks() {
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/get`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    allTasks = await response.json();
                    applyFilters();
                }
            } catch (error) { console.error(error); }
        }

        function applyFilters() {
            const cat = document.getElementById('filter-category').value;
            const imp = document.getElementById('filter-importance').value;
            const date = document.getElementById('filter-date').value;
            const filtered = allTasks.filter(t => {
                return (!cat || t.category === cat) && 
                       (!imp || t.importance === imp) && 
                       (!date || t.date.split('T')[0] === date);
            });
            renderTasks(filtered);
        }

        async function updateStatus(id, status) {
            await fetch(`${API_BASE_URL}/tasks/${id}/status?new_status=${status}`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadTasks();
        }

        async function deleteTask(id) {
            if (confirm("Excluir tarefa?")) {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    loadTasks();
                }
            }
        }

        function renderTasks(tasks) {
            const cols = {
                "To Do": document.getElementById('tasks-todo'),
                "In Progress": document.getElementById('tasks-progress'),
                "Done": document.getElementById('tasks-done')
            };
            Object.values(cols).forEach(c => c.innerHTML = '');

            tasks.forEach(t => {
                let btns = '';
                if (t.status === 'To Do') {
                    btns = `<button class="act-btn" onclick="updateStatus(${t.id}, 'In Progress')"><i class="fas fa-play"></i></button>`;
                } else if (t.status === 'In Progress') {
                    btns = `
                        <button class="act-btn" onclick="updateStatus(${t.id}, 'To Do')"><i class="fas fa-undo"></i></button>
                        <button class="act-btn" onclick="updateStatus(${t.id}, 'Done')"><i class="fas fa-check"></i></button>`;
                } else {
                    btns = `<button class="act-btn" onclick="updateStatus(${t.id}, 'In Progress')"><i class="fas fa-redo"></i></button>`;
                }

                const card = `
                    <div class="task-card">
                        <div class="task-body">
                            <span class="task-title">${t.title}</span>
                            <div class="task-tags">
                                <span class="tag"><i class="fas fa-tag"></i> ${t.category}</span>
                                <span class="tag"><i class="fas fa-calendar"></i> ${t.date.split('T')[0]}</span>
                                <span class="tag priority-tag">${t.importance}</span>
                            </div>
                        </div>
                        <div class="task-footer">
                            <button class="act-btn del" onclick="deleteTask(${t.id})"><i class="fas fa-trash-alt"></i></button>
                            <div class="status-group">
                                ${btns}
                            </div>
                        </div>
                    </div>`;
                if (cols[t.status]) cols[t.status].innerHTML += card;
            });

            document.getElementById('count-total').innerText = tasks.length;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('count-today').innerText = tasks.filter(t => t.date.split('T')[0] === today).length;
        }

        document.querySelectorAll('.styled-select').forEach(s => s.addEventListener('change', applyFilters));
        document.getElementById('clear-date').addEventListener('click', () => {
            document.getElementById('filter-date').value = '';
            applyFilters();
        });

        document.querySelector('.task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('task-title').value,
                date: document.getElementById('task-date').value,
                status: document.getElementById('task-status').value,
                category: document.getElementById('task-category').value,
                importance: document.getElementById('task-importance').value 
            };
            const res = await fetch(`${API_BASE_URL}/tasks/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                document.getElementById('modal-control').checked = false;
                e.target.reset();
                loadTasks();
            }
        });

        loadTasks();
    </script>
</body>
</html>